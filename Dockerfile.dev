# =========================
# ğŸ§± Base stage: devç’°å¢ƒæ§‹ç¯‰
# =========================
FROM node:24-bookworm AS base

ARG UID=2000
ARG GID=2000
ARG USERNAME=devuser

ENV CARGO_HOME="/cargo"
ENV PATH="${CARGO_HOME}/bin:$PATH"

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    sudo git curl build-essential pkg-config \
    libssl-dev libudev-dev libx11-dev libxrandr-dev libxss-dev libxtst-dev libxi-dev \
    libgl1-mesa-dev libgtk-3-dev libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev \
    libayatana-appindicator3-dev libglib2.0-dev libgdk-pixbuf2.0-dev libpango1.0-dev \
    libatk1.0-dev libcairo2-dev libsoup2.4-dev librsvg2-dev

# devuser ä½œæˆ
RUN groupadd -g ${GID} ${USERNAME} \
 && useradd -u ${UID} -g ${GID} -m ${USERNAME} -s /bin/bash \
 && echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${USERNAME} \
 && chmod 0440 /etc/sudoers.d/${USERNAME}

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆrootã§ï¼‰
RUN npm install -g pnpm \
 && curl https://sh.rustup.rs -sSf | sh -s -- -y \
 && rustup default stable

WORKDIR /src

# =========================
# ğŸ“¦ Dependencies stage
# =========================
FROM base AS deps

# devuser ã«åˆ‡ã‚Šæ›¿ãˆ
ARG UID=2000
ARG GID=2000
ARG USERNAME=devuser

RUN chown -R ${USERNAME}:${USERNAME} /src
RUN chown -R ${USERNAME}:${USERNAME} /cargo
USER ${USERNAME}

WORKDIR /src

# ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼
COPY --chown=${UID}:${GID} package.json pnpm-lock.yaml ./

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¦ãƒ³ãƒˆ + installï¼ˆdevuserã§ï¼‰
RUN --mount=type=cache,id=pnpm_store,target=/src/.pnpm-store \
    pnpm install --frozen-lockfile

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
COPY --chown=${UID}:${GID} . .

# Rust toolchainç¢ºèªï¼ˆdevuserã§ï¼‰
RUN /cargo/bin/rustup default stable

# ç’°å¢ƒå¤‰æ•°ã¨ãƒãƒ¼ãƒˆè¨­å®š
ENV PORT=8080
EXPOSE 8080

CMD ["pnpm", "dev"]

# =========================
# ğŸ”¨ Builder stageï¼ˆä»»æ„ï¼‰
# =========================
# FROM deps AS builder
# RUN pnpm build || pnpm tauri build

# =========================
# ğŸš€ Runtime stageï¼ˆä»»æ„ï¼‰
# =========================
# FROM node:24-bookworm AS runtime
# ARG UID=2000
# ARG GID=2000
# ARG USERNAME=devuser
# RUN groupadd -g ${GID} ${USERNAME} \
#  && useradd -u ${UID} -g ${GID} -m ${USERNAME} -s /bin/bash
# USER ${USERNAME}
# WORKDIR /app
# COPY --from=builder /src/dist ./dist
# EXPOSE 8080
# CMD ["node", "dist/server.js"]